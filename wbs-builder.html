<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WBS Builder — Project Management Tool</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0f1117;
    --surface: #181c27;
    --surface2: #1e2435;
    --border: #2a3047;
    --border-hover: #3d4a6b;
    --accent: #4f7cff;
    --accent-soft: rgba(79,124,255,0.15);
    --accent-glow: rgba(79,124,255,0.35);
    --green: #2dd4a0;
    --green-soft: rgba(45,212,160,0.12);
    --orange: #ff8c42;
    --text: #e8eaf0;
    --text-muted: #6b7595;
    --text-dim: #3d4a6b;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --shadow-hover: 0 8px 40px rgba(0,0,0,0.6);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: auto;
  }

  /* ── TOOLBAR ── */
  .toolbar {
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: rgba(15,17,23,0.92);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }
  .toolbar-brand {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    color: var(--accent);
    margin-right: 16px;
    white-space: nowrap;
  }
  .toolbar-sep { width: 1px; height: 24px; background: var(--border); margin: 0 8px; }
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .18s;
    white-space: nowrap;
  }
  .btn:hover { border-color: var(--accent); background: var(--accent-soft); color: var(--accent); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn.primary:hover { background: #3d68e8; }
  .btn svg { width: 14px; height: 14px; flex-shrink: 0; }
  .toolbar-right { margin-left: auto; display: flex; gap: 8px; }

  /* ── CANVAS ── */
  .canvas {
    padding: 48px 40px;
    min-width: max-content;
  }

  /* ── WBS TREE ── */
  .wbs-level {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .wbs-row {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 0;
    position: relative;
  }

  /* connector lines */
  .wbs-row::before {
    content: '';
    position: absolute;
    top: -20px;
    left: 50%;
    width: 1px;
    height: 20px;
    background: var(--border);
  }
  .wbs-children-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }
  .wbs-children {
    display: flex;
    flex-direction: row;
    gap: 12px;
    position: relative;
    padding-top: 20px;
  }
  /* horizontal line spanning children */
  .wbs-children::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 60px);
    height: 1px;
    background: var(--border);
  }
  /* vertical line from parent to horizontal */
  .wbs-children::after {
    content: '';
    position: absolute;
    top: -20px;
    left: 50%;
    width: 1px;
    height: 20px;
    background: var(--border);
  }
  /* single child: no horizontal line */
  .wbs-children.single::before { display: none; }

  .node-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  /* sibling add buttons */
  .sibling-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0;
  }
  .add-sibling {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1.5px dashed var(--border);
    background: transparent;
    color: var(--text-dim);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .18s;
    flex-shrink: 0;
    line-height: 1;
    font-family: monospace;
    position: relative;
    top: 0;
  }
  .add-sibling:hover {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
    transform: scale(1.15);
  }

  /* ── NODE CARD ── */
  .node-card {
    width: 220px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    box-shadow: var(--shadow);
    transition: border-color .18s, box-shadow .18s;
    position: relative;
  }
  .node-card:hover {
    border-color: var(--border-hover);
    box-shadow: var(--shadow-hover);
  }
  .node-card.root-card {
    width: 260px;
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent-glow), var(--shadow);
  }
  .node-card.highlighted {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-soft);
  }

  .node-code {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    color: var(--accent);
    letter-spacing: 0.08em;
    margin-bottom: 6px;
    user-select: none;
  }
  .root-card .node-code { color: var(--green); font-size: 11px; }

  .node-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    border: none;
    background: transparent;
    width: 100%;
    outline: none;
    font-family: 'DM Sans', sans-serif;
    cursor: text;
    padding: 2px 4px;
    border-radius: 4px;
    transition: background .15s;
    resize: none;
    overflow: hidden;
    line-height: 1.4;
    min-height: 22px;
  }
  .node-name:focus {
    background: var(--surface2);
    box-shadow: inset 0 0 0 1px var(--accent);
  }
  .node-name::placeholder { color: var(--text-dim); font-weight: 400; }

  .node-dates {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    margin-top: 8px;
  }
  .date-field {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .date-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  .date-input {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 6px;
    width: 100%;
    outline: none;
    transition: border-color .15s;
  }
  .date-input:focus { border-color: var(--accent); }
  .date-input::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }

  .node-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity .15s;
  }
  .node-card:hover .node-actions { opacity: 1; }
  .node-action-btn {
    width: 22px;
    height: 22px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .15s;
    padding: 0;
  }
  .node-action-btn:hover { border-color: #ff5252; color: #ff5252; background: rgba(255,82,82,0.1); }
  .node-action-btn svg { width: 11px; height: 11px; }

  /* add child button */
  .add-child-wrap {
    margin-top: 8px;
    display: flex;
    justify-content: center;
  }
  .add-child {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 1.5px dashed var(--border);
    background: transparent;
    color: var(--text-dim);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .18s;
    font-family: monospace;
    line-height: 1;
  }
  .add-child:hover {
    border-color: var(--green);
    background: var(--green-soft);
    color: var(--green);
    transform: scale(1.15);
  }

  /* connector from node bottom to children line */
  .child-connector {
    width: 1px;
    height: 20px;
    background: var(--border);
    margin: 0 auto;
  }

  /* ── MODAL ── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    width: 440px;
    box-shadow: var(--shadow-hover);
  }
  .modal h2 { font-family: 'DM Serif Display', serif; font-size: 22px; margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 24px; justify-content: flex-end; }

  /* ── TOAST ── */
  .toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: var(--surface2);
    border: 1px solid var(--green);
    color: var(--green);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    z-index: 300;
    opacity: 0;
    transform: translateY(10px);
    transition: all .3s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* ── EMPTY STATE ── */
  .empty-hint {
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
    margin-top: 16px;
    opacity: 0.6;
  }

  /* hide browser date icon on Firefox */
  input[type="date"]::-moz-focus-inner { border: 0; }
</style>
</head>
<body>

<!-- TOOLBAR -->
<div class="toolbar">
  <span class="toolbar-brand">⬡ WBS Builder</span>
  <div class="toolbar-sep"></div>
  <button class="btn" onclick="newProject()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M8 2v12M2 8h12"/></svg>
    Nuevo
  </button>
  <button class="btn" onclick="triggerLoad()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 10v3a1 1 0 001 1h10a1 1 0 001-1v-3M8 2v8M5 6l3-3 3 3"/></svg>
    Abrir
  </button>
  <input type="file" id="fileInput" accept=".wbs,.json" style="display:none" onchange="loadFile(event)">
  <div class="toolbar-sep"></div>
  <div class="toolbar-right">
    <button class="btn" onclick="saveFile()">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M13 11v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4a1 1 0 011-1h6l3 3v5z"/><path d="M5 14V9h6v5M10 3v3H6"/></svg>
      Guardar .wbs
    </button>
    <button class="btn primary" onclick="exportCSV()">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 2H4a1 1 0 00-1 1v10a1 1 0 001 1h8a1 1 0 001-1V6L9 2z"/><path d="M9 2v4h4M6 9h4M6 12h4M6 6h1"/></svg>
      Exportar CSV
    </button>
  </div>
</div>

<!-- CANVAS -->
<div class="canvas" id="canvas"></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ─────────────────────────────────────────────
//  DATA MODEL
// ─────────────────────────────────────────────
let tree = null;
let idCounter = 0;

function createNode(name = 'Nueva tarea', level = 1, indexInLevel = 1) {
  return {
    id: ++idCounter,
    name,
    code: `${level}.${indexInLevel}`,
    startDate: '',
    endDate: '',
    children: [],
    level,
  };
}

function initProject() {
  idCounter = 0;
  tree = {
    id: ++idCounter,
    name: 'Mi Proyecto',
    code: '1.1',
    startDate: '',
    endDate: '',
    children: [],
    level: 1,
    isRoot: true,
  };
}

// ─────────────────────────────────────────────
//  CODE RECALCULATION
// ─────────────────────────────────────────────
function recalcCodes(node, level, index) {
  if (node.isRoot) {
    node.code = '1.1';
    node.level = 1;
  } else {
    node.code = `${level}.${index}`;
    node.level = level;
  }
  node.children.forEach((child, i) => recalcCodes(child, level + 1, i + 1));
}

// ─────────────────────────────────────────────
//  TREE MANIPULATION
// ─────────────────────────────────────────────
function findParent(node, targetId) {
  for (let i = 0; i < node.children.length; i++) {
    if (node.children[i].id === targetId) return { parent: node, index: i };
    const found = findParent(node.children[i], targetId);
    if (found) return found;
  }
  return null;
}

function addChild(parentId) {
  const parent = findNodeById(tree, parentId);
  if (!parent) return;
  const newNode = createNode('Nueva tarea', parent.level + 1, parent.children.length + 1);
  parent.children.push(newNode);
  recalcCodes(tree, 1, 1);
  render();
  setTimeout(() => focusNode(newNode.id), 50);
}

function addSibling(nodeId, direction) {
  if (nodeId === tree.id) return; // root has no siblings
  const res = findParent(tree, nodeId);
  if (!res) return;
  const { parent, index } = res;
  const insertAt = direction === 'left' ? index : index + 1;
  const newNode = createNode('Nueva tarea', parent.level + 1, insertAt + 1);
  parent.children.splice(insertAt, 0, newNode);
  recalcCodes(tree, 1, 1);
  render();
  setTimeout(() => focusNode(newNode.id), 50);
}

function deleteNode(nodeId) {
  if (nodeId === tree.id) return;
  const res = findParent(tree, nodeId);
  if (!res) return;
  res.parent.children.splice(res.index, 1);
  recalcCodes(tree, 1, 1);
  render();
}

function findNodeById(node, id) {
  if (node.id === id) return node;
  for (const child of node.children) {
    const found = findNodeById(child, id);
    if (found) return found;
  }
  return null;
}

function updateField(nodeId, field, value) {
  const node = findNodeById(tree, nodeId);
  if (node) node[field] = value;
}

function focusNode(id) {
  const el = document.querySelector(`[data-nodeid="${id}"] .node-name`);
  if (el) { el.focus(); el.select(); }
}

// ─────────────────────────────────────────────
//  RENDER
// ─────────────────────────────────────────────
function render() {
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = '';
  if (!tree) return;
  canvas.appendChild(buildNodeEl(tree, true));
}

function buildNodeEl(node, isRoot) {
  const wrapper = document.createElement('div');
  wrapper.className = 'node-wrapper';
  wrapper.dataset.nodeid = node.id;

  // sibling row (left btn + card + right btn)
  const siblingRow = document.createElement('div');
  siblingRow.className = 'sibling-row';

  if (!isRoot) {
    const leftBtn = document.createElement('button');
    leftBtn.className = 'add-sibling';
    leftBtn.title = 'Agregar hermana a la izquierda';
    leftBtn.textContent = '+';
    leftBtn.onclick = () => addSibling(node.id, 'left');
    siblingRow.appendChild(leftBtn);
  }

  const card = buildCard(node, isRoot);
  siblingRow.appendChild(card);

  if (!isRoot) {
    const rightBtn = document.createElement('button');
    rightBtn.className = 'add-sibling';
    rightBtn.title = 'Agregar hermana a la derecha';
    rightBtn.textContent = '+';
    rightBtn.onclick = () => addSibling(node.id, 'right');
    siblingRow.appendChild(rightBtn);
  }

  wrapper.appendChild(siblingRow);

  // add child button (below card)
  const addChildWrap = document.createElement('div');
  addChildWrap.className = 'add-child-wrap';
  const addBtn = document.createElement('button');
  addBtn.className = 'add-child';
  addBtn.title = 'Agregar hijo (nivel siguiente)';
  addBtn.textContent = '+';
  addBtn.onclick = () => addChild(node.id);
  addChildWrap.appendChild(addBtn);
  wrapper.appendChild(addChildWrap);

  // children
  if (node.children.length > 0) {
    const connector = document.createElement('div');
    connector.className = 'child-connector';
    wrapper.appendChild(connector);

    const childrenEl = document.createElement('div');
    childrenEl.className = 'wbs-children' + (node.children.length === 1 ? ' single' : '');

    node.children.forEach(child => {
      childrenEl.appendChild(buildNodeEl(child, false));
    });

    wrapper.appendChild(childrenEl);
  }

  return wrapper;
}

function buildCard(node, isRoot) {
  const card = document.createElement('div');
  card.className = 'node-card' + (isRoot ? ' root-card' : '');

  // code
  const codeEl = document.createElement('div');
  codeEl.className = 'node-code';
  codeEl.textContent = node.code;
  card.appendChild(codeEl);

  // delete button (not for root)
  if (!isRoot) {
    const actions = document.createElement('div');
    actions.className = 'node-actions';
    const delBtn = document.createElement('button');
    delBtn.className = 'node-action-btn';
    delBtn.title = 'Eliminar nodo';
    delBtn.innerHTML = `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 4h10M6 4V2h4v2M5 4v8a1 1 0 001 1h4a1 1 0 001-1V4"/></svg>`;
    delBtn.onclick = () => deleteNode(node.id);
    actions.appendChild(delBtn);
    card.appendChild(actions);
  }

  // name
  const nameEl = document.createElement('textarea');
  nameEl.className = 'node-name';
  nameEl.value = node.name;
  nameEl.placeholder = isRoot ? 'Nombre del proyecto...' : 'Nombre de la tarea...';
  nameEl.rows = 1;
  nameEl.oninput = function() {
    updateField(node.id, 'name', this.value);
    // auto resize
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
  };
  nameEl.onkeydown = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); this.blur(); }
  };
  card.appendChild(nameEl);

  // dates
  const datesEl = document.createElement('div');
  datesEl.className = 'node-dates';

  const startWrap = document.createElement('div');
  startWrap.className = 'date-field';
  const startLabel = document.createElement('div');
  startLabel.className = 'date-label';
  startLabel.textContent = 'Inicio';
  const startInput = document.createElement('input');
  startInput.type = 'date';
  startInput.className = 'date-input';
  startInput.value = node.startDate;
  startInput.onchange = () => updateField(node.id, 'startDate', startInput.value);
  startWrap.appendChild(startLabel);
  startWrap.appendChild(startInput);

  const endWrap = document.createElement('div');
  endWrap.className = 'date-field';
  const endLabel = document.createElement('div');
  endLabel.className = 'date-label';
  endLabel.textContent = 'Fin';
  const endInput = document.createElement('input');
  endInput.type = 'date';
  endInput.className = 'date-input';
  endInput.value = node.endDate;
  endInput.onchange = () => updateField(node.id, 'endDate', endInput.value);
  endWrap.appendChild(endLabel);
  endWrap.appendChild(endInput);

  datesEl.appendChild(startWrap);
  datesEl.appendChild(endWrap);
  card.appendChild(datesEl);

  return card;
}

// ─────────────────────────────────────────────
//  FILE I/O
// ─────────────────────────────────────────────
function saveFile() {
  if (!tree) return;
  const data = JSON.stringify({ version: 1, tree, idCounter }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const safeName = (tree.name || 'proyecto').replace(/[^a-z0-9]/gi, '_').toLowerCase();
  a.download = `${safeName}.wbs`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('✓ Guardado como ' + safeName + '.wbs');
}

function triggerLoad() {
  document.getElementById('fileInput').click();
}

function loadFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      tree = data.tree;
      idCounter = data.idCounter || 9999;
      recalcCodes(tree, 1, 1);
      render();
      showToast('✓ Proyecto cargado: ' + tree.name);
    } catch(err) {
      showToast('✗ Error al leer el archivo');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function newProject() {
  if (tree && !confirm('¿Crear un nuevo proyecto? Se perderán los cambios no guardados.')) return;
  initProject();
  recalcCodes(tree, 1, 1);
  render();
  setTimeout(() => focusNode(tree.id), 50);
}

// ─────────────────────────────────────────────
//  CSV EXPORT
// ─────────────────────────────────────────────
function collectNodes(node, rows) {
  rows.push({
    wbs_code: node.code,
    name: node.name,
    start_date: node.startDate,
    end_date: node.endDate,
  });
  node.children.forEach(c => collectNodes(c, rows));
}

function exportCSV() {
  if (!tree) return;
  const rows = [];
  collectNodes(tree, rows);
  const header = 'WBS_Code,Name,Start_Date,End_Date\n';
  const csvRows = rows.map(r =>
    [r.wbs_code, `"${(r.name || '').replace(/"/g, '""')}"`, r.start_date, r.end_date].join(',')
  );
  const csv = header + csvRows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const safeName = (tree.name || 'proyecto').replace(/[^a-z0-9]/gi, '_').toLowerCase();
  a.download = `${safeName}_wbs.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('✓ CSV exportado');
}

// ─────────────────────────────────────────────
//  TOAST
// ─────────────────────────────────────────────
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ─────────────────────────────────────────────
//  INIT
// ─────────────────────────────────────────────
initProject();
recalcCodes(tree, 1, 1);
render();
setTimeout(() => focusNode(tree.id), 80);
</script>
</body>
</html>
